version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: poker-mysql
    restart: always
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: poker
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    command: --default-authentication-plugin=caching_sha2_password
    networks:
      - poker-network

  redis:
    image: redis:7-alpine
    container_name: poker-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - poker-network

  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: poker-nacos
    restart: always
    ports:
      - "8848:8848"
      - "9848:9848"
    environment:
      MODE: standalone
      SPRING_DATASOURCE_PLATFORM: ""
      JVM_XMS: 256m
      JVM_XMX: 256m
    networks:
      - poker-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ========== 业务服务层 ==========
  
  poker-gateway:
    build:
      context: ../poker-backend
      dockerfile: poker-gateway/Dockerfile
    container_name: poker-gateway
    restart: always
    ports:
      - "8080:8080"
    environment:
      NACOS_ADDR: nacos:8848
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: root123
      REDIS_HOST: redis
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_started
    networks:
      - poker-network

  poker-user:
    build:
      context: ../poker-backend
      dockerfile: poker-user/Dockerfile
    container_name: poker-user
    restart: always
    ports:
      - "8081:8081"
    environment:
      NACOS_ADDR: nacos:8848
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: root123
      REDIS_HOST: redis
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_started
    networks:
      - poker-network

  poker-game:
    build:
      context: ../poker-backend
      dockerfile: poker-game/Dockerfile
    container_name: poker-game
    restart: always
    ports:
      - "8082:8082"
    environment:
      NACOS_ADDR: nacos:8848
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: root123
      REDIS_HOST: redis
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_started
    networks:
      - poker-network

  poker-room:
    build:
      context: ../poker-backend
      dockerfile: poker-room/Dockerfile
    container_name: poker-room
    restart: always
    ports:
      - "8083:8083"
    environment:
      NACOS_ADDR: nacos:8848
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: root123
      REDIS_HOST: redis
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_started
    networks:
      - poker-network

  poker-match:
    build:
      context: ../poker-backend
      dockerfile: poker-match/Dockerfile
    container_name: poker-match
    restart: always
    ports:
      - "8084:8084"
    environment:
      NACOS_ADDR: nacos:8848
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: root123
      REDIS_HOST: redis
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_started
    networks:
      - poker-network

  poker-admin:
    build:
      context: ../poker-backend
      dockerfile: poker-admin/Dockerfile
    container_name: poker-admin
    restart: always
    ports:
      - "8085:8085"
    environment:
      NACOS_ADDR: nacos:8848
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: root123
      REDIS_HOST: redis
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_started
    networks:
      - poker-network

volumes:
  mysql_data:
  redis_data:

networks:
  poker-network:
    driver: bridge
